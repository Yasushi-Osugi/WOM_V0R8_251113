# pysi/plugins/sample_price_tweak.py
from __future__ import annotations
import os
from typing import Any
from pysi.hooks.core import filter

# 価格を軽く調整するサンプル（安全：必ずコピー上で）
# 環境変数で倍率を指定（デフォルト 1.05）
_FACTOR = float(os.getenv("PRICE_TWEAK_FACTOR", "1.05"))

@filter("offering_price_df", priority=60)
def tweak_offering_price(df, scenario_id: str|None=None, **ctx: Any):
    """
    offering_price_TOBE があればそれを、無ければ ASIS を基に倍率を掛ける。
    'BASE' では変更しない例。実プロジェクトでは scenario_id による条件分岐を調整してください。
    """
    try:
        if (scenario_id or "").upper() in ("", "BASE"):
            return df  # ベースは素通し

        out = df.copy()
        asis = out.get("offering_price_ASIS")
        tobe = out.get("offering_price_TOBE")

        # 最終保存に使う列が app 側で "price" 合成なら、ここでは表示/比較に効く列だけ触る
        if tobe is not None:
            out["offering_price_TOBE"] = _safe_num(tobe) * _FACTOR
        elif asis is not None:
            out["offering_price_ASIS"] = _safe_num(asis) * _FACTOR
        return out
    except Exception:
        return df  # 壊さない

def _safe_num(s):
    import pandas as pd
    return pd.to_numeric(s, errors="coerce").fillna(0.0)
